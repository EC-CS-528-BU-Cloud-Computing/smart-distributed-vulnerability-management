package neo4j

import "github.com/neo4j/neo4j-go-driver/v4/neo4j"

type Client neo4j.Driver
type Transaction neo4j.Transaction

func createDriver(uri, username, password string) (Client, error) {
	return neo4j.NewDriver(uri, neo4j.BasicAuth(username, password, ""))
}

func closeDriver(driver neo4j.Driver) error {
	return driver.Close()
}

func generate_relation(image_name string, base_image_name string) error {
	const (
		uri      = "neo4j://localhost:7474"
		username = "neo4j"
		pwd      = "test"
	)
	client, err := createDriver(uri, username, pwd)
	defer func(driver Client) {
		_ = closeDriver(driver)
	}(client)
	if err != nil {
		return err
	}
	session := client.NewSession(neo4j.SessionConfig{AccessMode: neo4j.AccessModeWrite})
	defer session.Close()

	// create the new relation between an image and its base image
	_, err = session.WriteTransaction(func(tx neo4j.Transaction) (interface{}, error) {
		var result, err = tx.Run("MATCH (image:PackageNode {name: $image_name}) "+
			"MATCH (b_image:PackageNode {name: $base_name}) "+
			"MERGE (image)-[:BASE_IMAGE]->(b_image)",
			map[string]interface{}{"image_name": image_name, "base_name": base_image_name})
		if err != nil {
			return nil, err
		}
		return result.Consume()
	})
	if err != nil {
		return err
	}
	return nil
}
