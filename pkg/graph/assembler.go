package graph

import (
	"fmt"
	"path/filepath"
	"strings"

	"github.com/everfix/pkg/config"
	"github.com/everfix/pkg/neo4j"
	"github.com/everfix/pkg/parser"
	"github.com/everfix/pkg/sbom"
)

func AssembleGraph(image string, source string, dockerfile string) {
	if image == "scratch" {
		return
	}
	// generate sbom for current image
	fmt.Println("Generating SBOM for image: ", image)
	sbom.GenerateSBOM(image, source, sbom.SPDX_JSON)
	baseImages, err := parser.GetBaseImages(filepath.Join(config.DOCKERFILE_DIR, dockerfile))
	if err != nil {
		return
	}
	imageName := filepath.Join(config.ImageSource, strings.Replace(config.ImageName, ":", "-", -1))
	for _, base := range baseImages {
		baseImage := base.Name + ":" + base.Tag
		AssembleGraph(baseImage, config.ImageSource, baseImage)
		// parse sbom and generate clusters
		fmt.Println("Parsing SBOM and building dependency tree for image: ", image)
		err = parser.Parse(filepath.Join(config.SBOM_DIR, ""))
		if err != nil {
			return
		}
		// add relationship from image to its base
		baseName := filepath.Join(config.ImageSource, base.Name) + "-" + base.Tag
		neo4j.GenerateRelation(imageName, baseName)
	}

}
