package config

import (
	"bufio"
	"encoding/json"
	"io/ioutil"
	"log"
	"os"
	"strings"
)

type StepOP string

const (
	// For DB connection
	Uri      = "neo4j://localhost:7687"
	Username = "neo4j"
	Pwd      = "test"
	Realm    = ""

	// For vulnerability
	WONT_FIX   = "won't fix"
	NEGLIGIBLE = "Negligible"
	LOW        = "Low"
	MEDIUM     = "Medium"
	HIGH       = "High"
	CRITICAL   = "Critical"

	// File directories
	SBOM_DIR       = "bom"
	DOCKERFILE_DIR = "dockerfile"

	// Remediation workflow type
	FIX     StepOP = "fix"
	REBUILD StepOP = "rebuild"

	// File types
	SPDX_JSON = "spdx-json"
	JSON      = "json"
	TEXT      = "text"
	GITHUB    = "github"
	TABLE     = "table"
)

type ImageConfig struct {
	ImageName   string
	ImageSource string
}

type RPCConfig struct {
	Timeout    int
	RetryTimes int
	//ImagesUri  map[string]string
}

type Config struct {
	// image info
	ImageConfig ImageConfig
	// rpc info
	RPCConfig RPCConfig
	// address info
	AddressConfig map[string]string
}

// Helper functions

func Contains(items []string, item string) bool {
	for _, eachItem := range items {
		if eachItem == item {
			return true
		}
	}
	return false
}

func InitConfig(conf *Config) error {
	content, err := ioutil.ReadFile("config/config.json")
	if err != nil {
		log.Fatal("Error opening config file")
		return err
	}
	err = json.Unmarshal(content, &conf)
	if err != nil {
		log.Fatal("Error loading config data")
		return err
	}
	addressConfig := make(map[string]string)
	conf.AddressConfig = addressConfig
	err = InitAddressInfo(conf)
	return nil
}

func InitAddressInfo(conf *Config) error {
	readFile, err := os.Open("config/images_address")
	defer readFile.Close()
	if err != nil {
		log.Fatal("Error opening address config file")
		return err
	}
	fileScanner := bufio.NewScanner(readFile)
	fileScanner.Split(bufio.ScanLines)
	for fileScanner.Scan() {
		line := fileScanner.Text()
		image := strings.Split(line, " ")[0]
		address := strings.Split(line, " ")[1]
		conf.AddressConfig[image] = address
	}
	return nil
}
