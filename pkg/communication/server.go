package communication

import (
	"fmt"
	"github.com/everfix/pkg/config"
	"math/rand"
	"time"
)

func Fix(req *RequestMessage, rsp *ResponseMessage) {
	imageToFix := req.ImageName
	vulnerability := req.VulnerabilityName
	action := req.Action
	if action == config.FIX {
		FixImage(imageToFix, vulnerability, rsp)
	} else if action == config.REBUILD {
		baseImagesVersion := req.BaseImageVersion
		RebuildImage(imageToFix, vulnerability, baseImagesVersion, rsp)
	}
}

func FixImage(image string, vulnerability string, rsp *ResponseMessage) {
	fmt.Println(image)
	time.Sleep(1000)
	rsp.FixedVersion = string(rand.Int())
	rsp.ImageName = image
	rsp.VulnerabilityName = vulnerability
	rsp.Success = true
}

func RebuildImage(image string, vulnerability string, baseImageVersion map[string]string, rsp *ResponseMessage) {
	fmt.Println(image)
	fmt.Println(baseImageVersion)
	time.Sleep(2000)
	rsp.FixedVersion = string(rand.Int())
	rsp.ImageName = image
	rsp.VulnerabilityName = vulnerability
	rsp.Success = true
}
